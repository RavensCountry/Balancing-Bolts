<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Balancing Bolts ‚Äî Apartment Inventory Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg-gradient-start: #f0f4f8;
        --bg-gradient-end: #e2e8f0;
        --text-primary: #1a202c;
        --text-secondary: #4a5568;
        --text-muted: #718096;
        --card-bg: #ffffff;
        --card-border: #e2e8f0;
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --primary: #4f46e5;
        --primary-hover: #4338ca;
        --primary-light: #eef2ff;
        --success: #10b981;
        --success-light: #d1fae5;
        --warning: #f59e0b;
        --warning-light: #fef3c7;
        --danger: #ef4444;
        --danger-light: #fee2e2;
        --info: #3b82f6;
        --info-light: #dbeafe;
      }

      body.dark-mode {
        --bg-gradient-start: #1a202c;
        --bg-gradient-end: #2d3748;
        --text-primary: #f7fafc;
        --text-secondary: #e2e8f0;
        --text-muted: #a0aec0;
        --card-bg: #2d3748;
        --card-border: #4a5568;
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        --primary: #6366f1;
        --primary-hover: #818cf8;
        --primary-light: #312e81;
        --success: #34d399;
        --success-light: #064e3b;
        --warning: #fbbf24;
        --warning-light: #78350f;
        --danger: #f87171;
        --danger-light: #7f1d1d;
        --info: #60a5fa;
        --info-light: #1e3a8a;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.6;
        transition: all 0.3s ease;
      }

      .container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 1.5rem;
      }

      /* Header Styles */
      .header {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--card-border);
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.5rem;
        letter-spacing: -0.025em;
      }

      .header p {
        font-size: 1.125rem;
        color: var(--text-secondary);
      }

      /* Navigation */
      .nav-tabs {
        display: flex;
        gap: 0.75rem;
        background: var(--card-bg);
        padding: 1rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--card-border);
        flex-wrap: wrap;
        overflow-x: auto;
      }

      .nav-tab {
        background: transparent;
        color: var(--text-secondary);
        border: 2px solid transparent;
        border-radius: 12px;
        padding: 0.75rem 1.25rem;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        white-space: nowrap;
      }

      .nav-tab:hover {
        background: var(--primary-light);
        color: var(--primary);
        transform: translateY(-2px);
      }

      .nav-tab.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      }

      .nav-tab-icon {
        font-size: 1.25rem;
      }

      /* Card Styles */
      .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
      }

      .card:hover {
        box-shadow: var(--card-shadow-hover);
        transform: translateY(-2px);
      }

      .card h2, .card h3 {
        color: var(--text-primary);
        margin-bottom: 1rem;
        font-weight: 700;
      }

      .card h2 {
        font-size: 1.5rem;
      }

      .card h3 {
        font-size: 1.25rem;
      }

      /* Stats Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        box-shadow: var(--card-shadow-hover);
        transform: translateY(-4px);
      }

      .stat-info h4 {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
      }

      .stat-value {
        font-size: 2.25rem;
        font-weight: 700;
        color: var(--text-primary);
      }

      .stat-icon {
        width: 64px;
        height: 64px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      }

      .stat-icon.success {
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      }

      .stat-icon.warning {
        background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
      }

      .stat-icon.info {
        background: linear-gradient(135deg, var(--info) 0%, #2563eb 100%);
      }

      /* Form Elements */
      input, select, textarea {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--card-border);
        border-radius: 12px;
        font-family: inherit;
        font-size: 1rem;
        background: var(--card-bg);
        color: var(--text-primary);
        transition: all 0.2s ease;
        margin-bottom: 1rem;
      }

      input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      button {
        padding: 0.875rem 1.5rem;
        border: none;
        border-radius: 12px;
        font-family: inherit;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
      }

      button.btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      }

      button.btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
      }

      button.btn-secondary {
        background: var(--card-bg);
        color: var(--text-primary);
        border: 2px solid var(--card-border);
      }

      button.btn-secondary:hover {
        background: var(--primary-light);
        border-color: var(--primary);
        color: var(--primary);
      }

      button.btn-danger {
        background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      }

      button.btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
      }

      button.btn-success {
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      }

      button:active {
        transform: translateY(0);
      }

      /* Grid Layouts */
      .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
      }

      .input-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .input-group > * {
        flex: 1;
        min-width: 200px;
      }

      /* Table Styles */
      .table-container {
        overflow-x: auto;
        border-radius: 12px;
        border: 1px solid var(--card-border);
        margin-top: 1rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: var(--primary-light);
      }

      th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--primary);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      td {
        padding: 1rem;
        border-bottom: 1px solid var(--card-border);
        color: var(--text-secondary);
      }

      tbody tr:hover {
        background: var(--primary-light);
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      /* Property Grid */
      .property-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .property-slot {
        background: var(--card-bg);
        border: 2px dashed var(--card-border);
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
        transition: all 0.3s ease;
      }

      .property-slot.filled {
        border-style: solid;
        border-color: var(--primary);
        background: var(--primary-light);
      }

      .property-slot:hover {
        transform: translateY(-2px);
        box-shadow: var(--card-shadow);
      }

      .property-name {
        font-weight: 700;
        font-size: 1.125rem;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
      }

      .property-address {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
      }

      /* Badge */
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        background: var(--primary-light);
        color: var(--primary);
      }

      .badge.success {
        background: var(--success-light);
        color: var(--success);
      }

      .badge.warning {
        background: var(--warning-light);
        color: var(--warning);
      }

      .badge.danger {
        background: var(--danger-light);
        color: var(--danger);
      }

      /* Alert/Message Styles */
      .alert {
        padding: 1rem 1.25rem;
        border-radius: 12px;
        margin: 1rem 0;
        font-size: 0.95rem;
      }

      .alert.info {
        background: var(--info-light);
        color: var(--info);
        border-left: 4px solid var(--info);
      }

      .alert.success {
        background: var(--success-light);
        color: var(--success);
        border-left: 4px solid var(--success);
      }

      .alert.warning {
        background: var(--warning-light);
        color: var(--warning);
        border-left: 4px solid var(--warning);
      }

      .alert.danger {
        background: var(--danger-light);
        color: var(--danger);
        border-left: 4px solid var(--danger);
      }

      /* Login Screen */
      #loginScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.7)),
                    url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><rect fill="%23111827" width="1200" height="800"/><g fill-opacity="0.15"><circle fill="%23374151" cx="100" cy="100" r="50"/><circle fill="%234b5563" cx="300" cy="200" r="60"/><circle fill="%23374151" cx="500" cy="150" r="45"/><circle fill="%236b7280" cx="700" cy="300" r="70"/><circle fill="%23374151" cx="900" cy="200" r="55"/><circle fill="%234b5563" cx="1100" cy="400" r="65"/><circle fill="%23374151" cx="200" cy="500" r="50"/><circle fill="%236b7280" cx="400" cy="600" r="60"/><circle fill="%23374151" cx="600" cy="550" r="45"/><circle fill="%234b5563" cx="800" cy="650" r="55"/><circle fill="%23374151" cx="1000" cy="600" r="50"/></g></svg>');
        background-size: cover;
        background-position: center;
        display: none;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        z-index: 1000;
      }

      #loginScreen.active {
        display: flex;
      }

      #loginScreen::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 20% 50%, rgba(79, 70, 229, 0.15) 0%, transparent 50%),
                    radial-gradient(circle at 80% 50%, rgba(16, 185, 129, 0.15) 0%, transparent 50%);
        pointer-events: none;
      }

      .login-container {
        max-width: 480px;
        width: 90%;
        z-index: 10;
        position: relative;
      }

      .login-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 24px;
        padding: 3rem 2.5rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      body.dark-mode .login-card {
        background: rgba(45, 55, 72, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .login-header {
        text-align: center;
        margin-bottom: 2.5rem;
      }

      .login-header h2 {
        font-size: 2.25rem;
        font-weight: 700;
        color: #06b6d4;
        margin-bottom: 0.75rem;
        letter-spacing: 0.02em;
        text-shadow: 0 2px 10px rgba(6, 182, 212, 0.3);
      }

      body.dark-mode .login-header h2 {
        color: #22d3ee;
      }

      .login-header p {
        color: var(--text-secondary);
        font-size: 1rem;
      }

      .login-form-group {
        margin-bottom: 1.25rem;
      }

      .login-form-group label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .login-form-group input {
        width: 100%;
        padding: 1rem 1.25rem;
        border: 2px solid rgba(226, 232, 240, 0.8);
        border-radius: 12px;
        font-size: 1rem;
        background: rgba(255, 255, 255, 0.9);
        color: var(--text-primary);
        transition: all 0.3s ease;
        margin-bottom: 0;
      }

      body.dark-mode .login-form-group input {
        background: rgba(31, 41, 55, 0.8);
        border-color: rgba(75, 85, 99, 0.8);
      }

      .login-form-group input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        background: white;
      }

      body.dark-mode .login-form-group input:focus {
        background: rgba(31, 41, 55, 0.95);
      }

      .login-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
      }

      .login-buttons button {
        flex: 1;
        padding: 1rem 1.5rem;
        font-size: 1.05rem;
        font-weight: 600;
      }

      .login-footer {
        margin-top: 1.5rem;
        text-align: center;
        font-size: 0.875rem;
        color: var(--text-muted);
        padding-top: 1rem;
        border-top: 1px solid rgba(226, 232, 240, 0.5);
      }

      body.dark-mode .login-footer {
        border-top-color: rgba(75, 85, 99, 0.5);
      }

      .login-signup-link {
        margin-top: 0.75rem;
        font-size: 0.875rem;
      }

      .login-signup-link button {
        background: none;
        border: none;
        color: #06b6d4;
        text-decoration: underline;
        cursor: pointer;
        padding: 0;
        font-size: 0.875rem;
        font-weight: 600;
      }

      .login-signup-link button:hover {
        color: #0891b2;
        transform: none;
      }

      /* Toggle Switch */
      .toggle-container {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 52px;
        height: 28px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
        margin: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--card-border);
        transition: 0.3s;
        border-radius: 34px;
      }

      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
      }

      input:checked + .toggle-slider {
        background-color: var(--primary);
      }

      input:checked + .toggle-slider:before {
        transform: translateX(24px);
      }

      /* Page visibility */
      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

      .main-app-container {
        display: none;
      }

      .main-app-container.active {
        display: block;
      }

      /* Pagination */
      .pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .pagination button {
        padding: 0.5rem 1rem;
      }

      .page-number {
        font-weight: 600;
        color: var(--text-primary);
        padding: 0.5rem 1rem;
        background: var(--primary-light);
        border-radius: 8px;
      }

      /* Loading Animation */
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid var(--card-border);
        border-radius: 50%;
        border-top-color: var(--primary);
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .container {
          padding: 1rem;
        }

        .header h1 {
          font-size: 2rem;
        }

        .nav-tabs {
          padding: 0.75rem;
        }

        .nav-tab {
          padding: 0.625rem 1rem;
          font-size: 0.875rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .stat-value {
          font-size: 1.75rem;
        }

        .login-card {
          padding: 2rem;
        }
      }

      /* Utility Classes */
      .text-center { text-align: center; }
      .text-muted { color: var(--text-muted); }
      .mb-1 { margin-bottom: 0.5rem; }
      .mb-2 { margin-bottom: 1rem; }
      .mb-3 { margin-bottom: 1.5rem; }
      .mt-1 { margin-top: 0.5rem; }
      .mt-2 { margin-top: 1rem; }
      .mt-3 { margin-top: 1.5rem; }
      .hidden { display: none !important; }
      .flex { display: flex; }
      .flex-center { display: flex; align-items: center; justify-content: center; }
      .gap-1 { gap: 0.5rem; }
      .gap-2 { gap: 1rem; }

      /* AI Chat Widget */
      #aiChatWidget {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 380px;
        max-height: 600px;
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border: 1px solid var(--card-border);
        display: none;
        flex-direction: column;
        z-index: 10000;
        transition: all 0.3s ease;
      }

      #aiChatWidget.visible {
        display: flex;
      }

      #aiChatWidget.minimized {
        max-height: 60px;
      }

      .chat-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
        color: white;
        padding: 1rem 1.25rem;
        border-radius: 16px 16px 0 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
      }

      .chat-header-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        font-size: 1rem;
      }

      .chat-header-controls {
        display: flex;
        gap: 0.5rem;
      }

      .chat-control-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
      }

      .chat-control-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-height: 440px;
        min-height: 440px;
      }

      #aiChatWidget.minimized .chat-messages {
        display: none;
      }

      .chat-message {
        display: flex;
        gap: 0.75rem;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .chat-message.user {
        flex-direction: row-reverse;
      }

      .chat-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
      }

      .chat-message.assistant .chat-avatar {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
        color: white;
      }

      .chat-message.user .chat-avatar {
        background: var(--success);
        color: white;
      }

      .chat-bubble {
        max-width: 75%;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        font-size: 0.9rem;
        line-height: 1.5;
        word-wrap: break-word;
      }

      .chat-message.assistant .chat-bubble {
        background: var(--primary-light);
        color: var(--text-primary);
        border-bottom-left-radius: 4px;
      }

      .chat-message.user .chat-bubble {
        background: var(--success);
        color: white;
        border-bottom-right-radius: 4px;
      }

      .chat-input-container {
        padding: 1rem 1.25rem;
        border-top: 1px solid var(--card-border);
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
      }

      #aiChatWidget.minimized .chat-input-container {
        display: none;
      }

      .chat-input {
        flex: 1;
        background: var(--bg-gradient-start);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 0.75rem;
        font-size: 0.9rem;
        color: var(--text-primary);
        resize: none;
        max-height: 100px;
        font-family: inherit;
        transition: border-color 0.2s ease;
      }

      .chat-input:focus {
        outline: none;
        border-color: var(--primary);
      }

      .chat-send-btn {
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 12px;
        width: 42px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .chat-send-btn:hover:not(:disabled) {
        background: var(--primary-hover);
        transform: translateY(-1px);
      }

      .chat-send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .chat-typing {
        display: flex;
        gap: 0.75rem;
        padding: 0.5rem 0;
      }

      .chat-typing .chat-bubble {
        display: flex;
        gap: 0.25rem;
        padding: 0.75rem 1rem;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--primary);
        animation: typingDot 1.4s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typingDot {
        0%, 60%, 100% {
          opacity: 0.3;
          transform: translateY(0);
        }
        30% {
          opacity: 1;
          transform: translateY(-8px);
        }
      }

      .chat-welcome {
        text-align: center;
        padding: 2rem 1rem;
        color: var(--text-muted);
      }

      .chat-welcome h3 {
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-size: 1.125rem;
      }

      .chat-welcome p {
        font-size: 0.875rem;
        line-height: 1.6;
      }

      @media (max-width: 768px) {
        #aiChatWidget {
          width: calc(100vw - 32px);
          right: 16px;
          bottom: 16px;
          max-height: 500px;
        }

        .chat-messages {
          max-height: 340px;
          min-height: 340px;
        }
      }

      /* User Management Tabs */
      .user-mgmt-tab.active {
        color: var(--primary) !important;
        border-bottom-color: var(--primary) !important;
      }

      .user-mgmt-tab:hover {
        color: var(--primary);
        background: var(--primary-light);
      }

      .employee-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .employee-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--card-shadow-hover);
        border-color: var(--primary);
      }

      .employee-role-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .employee-role-badge.admin {
        background: var(--primary-light);
        color: var(--primary);
      }

      .employee-role-badge.manager {
        background: var(--info-light);
        color: var(--info);
      }

      .employee-role-badge.maintenance {
        background: var(--warning-light);
        color: var(--warning);
      }

      .employee-role-badge.leasing {
        background: var(--success-light);
        color: var(--success);
      }

      /* Custom Modal Styles */
      .custom-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 10000;
        animation: fadeIn 0.2s ease;
      }

      .custom-modal-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .custom-modal {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        animation: slideUp 0.3s ease;
        border: 1px solid var(--card-border);
      }

      .custom-modal-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .custom-modal-icon {
        font-size: 2.5rem;
        flex-shrink: 0;
      }

      .custom-modal-icon.success {
        color: var(--success);
      }

      .custom-modal-icon.error {
        color: var(--danger);
      }

      .custom-modal-icon.warning {
        color: var(--warning);
      }

      .custom-modal-icon.info {
        color: var(--info);
      }

      .custom-modal-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
      }

      .custom-modal-message {
        color: var(--text-secondary);
        font-size: 1rem;
        line-height: 1.6;
        margin-bottom: 1.5rem;
      }

      .custom-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
      }

      .custom-modal-btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: inherit;
      }

      .custom-modal-btn-primary {
        background: var(--primary);
        color: white;
      }

      .custom-modal-btn-primary:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
      }

      .custom-modal-btn-secondary {
        background: var(--card-border);
        color: var(--text-secondary);
      }

      .custom-modal-btn-secondary:hover {
        background: var(--text-muted);
        color: var(--card-bg);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <!-- Custom Modal -->
    <div id="customModalOverlay" class="custom-modal-overlay">
      <div class="custom-modal">
        <div class="custom-modal-header">
          <div id="customModalIcon" class="custom-modal-icon"></div>
          <div>
            <h3 id="customModalTitle" class="custom-modal-title"></h3>
          </div>
        </div>
        <div id="customModalMessage" class="custom-modal-message"></div>
        <input id="customModalInput" type="text" style="display:none; width: 100%; padding: 0.75rem; border: 2px solid var(--card-border); border-radius: 8px; font-size: 1rem; margin-bottom: 1rem; font-family: inherit; background: var(--card-bg); color: var(--text-primary);" />
        <div class="custom-modal-footer">
          <button id="customModalCancelBtn" class="custom-modal-btn custom-modal-btn-secondary" style="display:none;">Cancel</button>
          <button id="customModalBtn" class="custom-modal-btn custom-modal-btn-primary">OK</button>
        </div>
      </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="page active">
      <div class="login-container">
        <div class="login-card">
          <div class="login-header">
            <h2>WELCOME TO BOLTS&BALANCE!</h2>
            <p>Apartment Inventory Management System</p>
          </div>
          <div class="login-form-group">
            <label for="login_email">üë§ Username</label>
            <input id="login_email" type="email" placeholder="Enter your email" />
          </div>
          <div class="login-form-group">
            <label for="login_password">üîí Password</label>
            <input id="login_password" type="password" placeholder="Enter your password" />
          </div>
          <div class="login-buttons">
            <button class="btn-primary" onclick="doLogin()">Sign In</button>
          </div>
          <div id="loginMsg" class="mt-2 text-center"></div>
          <div class="login-footer">
            If you do not have a login please contact your administrator
            <div class="login-signup-link">
              Need an account? <button onclick="doSignup()">Sign up here</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="main-app-container">
      <div class="container">
        <!-- Header -->
        <div class="header">
          <h1>üè¢ Balancing Bolts</h1>
          <p>Manage your apartment inventory with ease</p>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs" id="navTabs">
          <button class="nav-tab active" onclick="showPage('dashboard')">
            <span class="nav-tab-icon">üìä</span>
            <span>Dashboard</span>
          </button>
          <button class="nav-tab" onclick="showPage('inventory')">
            <span class="nav-tab-icon">üì¶</span>
            <span>Inventory</span>
          </button>
          <button class="nav-tab" onclick="showPage('properties')">
            <span class="nav-tab-icon">üè†</span>
            <span>Properties</span>
          </button>
          <button class="nav-tab" onclick="showPage('invoices')">
            <span class="nav-tab-icon">üìÑ</span>
            <span>Invoices</span>
          </button>
          <button class="nav-tab" onclick="showPage('quotes')">
            <span class="nav-tab-icon">üí∞</span>
            <span>Quotes</span>
          </button>
          <button class="nav-tab" onclick="showPage('reports')">
            <span class="nav-tab-icon">üìà</span>
            <span>Reports</span>
          </button>
          <button class="nav-tab" onclick="showPage('settings')">
            <span class="nav-tab-icon">‚öôÔ∏è</span>
            <span>Settings</span>
          </button>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page">
          <!-- Stats -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-info">
                <h4>Total Items</h4>
                <div class="stat-value" id="statTotalItems">0</div>
              </div>
              <div class="stat-icon">üì¶</div>
            </div>
            <div class="stat-card">
              <div class="stat-info">
                <h4>Total Spent</h4>
                <div class="stat-value" id="statTotalSpent">$0.00</div>
              </div>
              <div class="stat-icon success">üí∞</div>
            </div>
            <div class="stat-card">
              <div class="stat-info">
                <h4>Active Properties</h4>
                <div class="stat-value" id="statActiveProperties">0</div>
              </div>
              <div class="stat-icon warning">üè†</div>
            </div>
          </div>

          <!-- Current User Info -->
          <div class="card">
            <h3>üë§ Current User</h3>
            <div id="currentUserInfo">Loading...</div>
            <button class="btn-danger mt-2" onclick="logout()">Logout</button>
          </div>

          <!-- Quick Actions -->
          <div class="card">
            <h3>üöÄ Quick Actions</h3>
            <div class="input-group">
              <button class="btn-primary" onclick="showPage('inventory')">View Inventory</button>
              <button class="btn-primary" onclick="showPage('properties')">Manage Properties</button>
              <button class="btn-primary" onclick="showPage('invoices')">Import Invoices</button>
            </div>
          </div>
        </div>

        <!-- Inventory Page -->
        <div id="inventoryPage" class="page">
          <div class="card">
            <h3>üì¶ Inventory Browser</h3>
            <div class="input-group">
              <input id="inv_prop" type="number" placeholder="Property ID (optional)" />
              <input id="inv_per" type="number" placeholder="Items per page" value="10" />
              <button class="btn-primary" onclick="loadInventory(1)">Load Inventory</button>
            </div>

            <div class="table-container">
              <div id="invTable">Click "Load Inventory" to view items</div>
            </div>

            <div class="pagination">
              <button class="btn-secondary" onclick="prevPage()">‚Üê Previous</button>
              <span class="page-number">Page <span id="invPage">1</span></span>
              <button class="btn-secondary" onclick="nextPage()">Next ‚Üí</button>
            </div>
          </div>

          <!-- Add Inventory Item -->
          <div class="card">
            <h3>‚ûï Add New Inventory Item</h3>
            <div class="input-group">
              <input id="new_inv_name" placeholder="Item name" />
              <input id="new_inv_desc" placeholder="Description" />
            </div>
            <div class="input-group">
              <input id="new_inv_qty" type="number" placeholder="Quantity" value="1" />
              <input id="new_inv_cost" type="number" step="0.01" placeholder="Cost" value="0.00" />
              <input id="new_inv_prop" type="number" placeholder="Property ID" />
            </div>
            <button class="btn-success" onclick="addInventoryItem()" style="width: 100%;">Add Item</button>
            <div id="addInvResult" class="mt-2"></div>
          </div>
        </div>

        <!-- Properties Page -->
        <div id="propertiesPage" class="page">
          <div class="card">
            <h3>üè† Property Management</h3>
            <p class="text-muted mb-2">Manage up to 9 properties</p>
            <div id="propertiesGrid" class="property-grid"></div>
          </div>

          <!-- Add Property (Admin) -->
          <div class="card" id="adminAddProperty">
            <h3>‚ûï Add New Property</h3>
            <input id="newPropName" placeholder="Property name" />
            <input id="newPropAddress" placeholder="Address (optional)" />
            <button class="btn-success" onclick="createProperty()" style="width: 100%;">Create Property</button>
          </div>

          <!-- Delete Property (Admin) -->
          <div class="card" id="adminDeleteProperty">
            <h3>üóëÔ∏è Delete Property</h3>
            <select id="deletePropertySelect">
              <option value="">Select a property...</option>
            </select>
            <button class="btn-danger" onclick="deleteProperty()" style="width: 100%;">Delete Selected Property</button>
          </div>
        </div>

        <!-- Invoices Page -->
        <div id="invoicesPage" class="page">
          <div class="card">
            <h3>üìÑ Import Invoices from CSV</h3>
            <p class="text-muted mb-2">Upload a CSV file with columns: vendor, date, total, description</p>
            <div class="alert info" style="margin-bottom: 1rem;">
              <strong>ü§ñ Automatic Quote Generation:</strong> When you import invoices, the system will automatically identify reorderable items (like light bulbs, filters, cleaning supplies) and create quote requests. You can then compare prices from multiple vendors instantly!
            </div>
            <input type="file" id="csvFile" accept=".csv" />
            <select id="invoicePropertySelect">
              <option value="">Select property...</option>
            </select>
            <button class="btn-primary" onclick="uploadCSV()" style="width: 100%;">Upload CSV</button>
            <div id="importResult" class="mt-2"></div>
          </div>

          <div class="card" id="autoQuotesSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="margin: 0;">üí∞ Auto-Generated Quotes</h3>
              <button class="btn-secondary" onclick="hideAutoQuotes()" style="padding: 0.5rem 1rem;">Close</button>
            </div>
            <p class="text-muted mb-2">Quote requests automatically created from your invoice items:</p>
            <div id="autoQuotesList"></div>
          </div>
        </div>

        <!-- Reports Page -->
        <div id="reportsPage" class="page">
          <div class="card">
            <h3>üìà Monthly Report</h3>
            <div class="input-group">
              <input id="r_month_year" type="number" placeholder="Year (e.g., 2026)" />
              <input id="r_month" type="number" placeholder="Month (1-12)" min="1" max="12" />
              <input id="r_month_prop" type="number" placeholder="Property ID (optional)" />
            </div>
            <button class="btn-primary" onclick="getMonthlyReport()" style="width: 100%;">Generate Monthly Report</button>
            <pre id="monthlyResult" class="mt-2" style="background: var(--primary-light); padding: 1rem; border-radius: 8px; overflow: auto; max-height: 300px;"></pre>
          </div>

          <div class="card">
            <h3>üìä Yearly Report</h3>
            <div class="input-group">
              <input id="r_yearly_year" type="number" placeholder="Year (e.g., 2026)" />
              <input id="r_yearly_prop" type="number" placeholder="Property ID (optional)" />
            </div>
            <button class="btn-primary" onclick="getYearlyReport()" style="width: 100%;">Generate Yearly Report</button>
            <pre id="yearlyResult" class="mt-2" style="background: var(--primary-light); padding: 1rem; border-radius: 8px; overflow: auto; max-height: 300px;"></pre>
          </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
          <div class="card">
            <h3>üé® Appearance</h3>
            <div class="toggle-container">
              <label class="toggle-switch">
                <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                <span class="toggle-slider"></span>
              </label>
              <span>Dark Mode</span>
            </div>
          </div>

          <div class="card">
            <h3>üë§ User Information</h3>
            <div id="userSettingsInfo">Loading...</div>
            <button class="btn-danger" onclick="logout()" style="margin-top: 1rem; width: 100%;">
              üö™ Logout
            </button>
          </div>

          <!-- Admin: User Management -->
          <div class="card" id="adminUserManagement" style="display: none;">
            <h3>üë• User Management</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Manage employees, roles, and permissions</p>

            <!-- User Management Tabs -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--card-border);">
              <button class="user-mgmt-tab active" onclick="showUserManagementTab('employees')"
                      style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: var(--text-secondary); transition: all 0.2s;">
                üë§ Employees
              </button>
              <button class="user-mgmt-tab" onclick="showUserManagementTab('roles')"
                      style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: var(--text-secondary); transition: all 0.2s;">
                üé≠ Roles & Permissions
              </button>
            </div>

            <!-- Employees Tab -->
            <div id="employeesTab" class="user-mgmt-tab-content">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h4 style="margin: 0;">All Employees</h4>
                <input type="text" id="employeeSearch" placeholder="Search employees..."
                       oninput="filterEmployees()"
                       style="padding: 0.5rem 1rem; border: 1px solid var(--card-border); border-radius: 8px; background: var(--bg-gradient-start); color: var(--text-primary); width: 250px;" />
              </div>
              <div id="employeesList">Loading employees...</div>
            </div>

            <!-- Roles Tab -->
            <div id="rolesTab" class="user-mgmt-tab-content" style="display: none;">
              <h4 style="margin-bottom: 1.5rem;">Role Permissions</h4>
              <div id="rolesPermissions">
                <!-- Admin Role -->
                <div class="card" style="margin-bottom: 1.5rem; background: var(--primary-light); padding: 1.5rem;">
                  <h4 style="margin: 0 0 1rem 0; color: var(--primary);">üîë Admin</h4>
                  <p style="margin: 0 0 1rem 0; color: var(--text-secondary);">
                    Full system access with complete control over all features and data.
                  </p>
                  <div style="display: grid; gap: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>Manage all employees (add, edit, remove, change roles)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>View and manage ALL properties</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>Delete any information from the system</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>Manage vendor credentials and quotes</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>Access all reports and analytics</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>Complete system administration</span>
                    </div>
                  </div>
                </div>

                <!-- Manager Role -->
                <div class="card" style="margin-bottom: 1.5rem; background: var(--info-light); padding: 1.5rem;">
                  <h4 style="margin: 0 0 1rem 0; color: var(--info);">üë®‚Äçüíº Manager</h4>
                  <p style="margin: 0 0 1rem 0; color: var(--text-secondary);">
                    Property managers with authority over assigned properties and their staff.
                  </p>
                  <div style="display: grid; gap: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>Manage employees assigned to their properties only</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>View and edit assigned properties only</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>Remove invoices and items from assigned properties</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>Add and manage vendor credentials for quotes</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>Grant property access to employees for their properties</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--danger); font-size: 1.25rem;">‚úó</span>
                      <span style="opacity: 0.6;">Cannot change employee roles</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--danger); font-size: 1.25rem;">‚úó</span>
                      <span style="opacity: 0.6;">Cannot delete employees</span>
                    </div>
                  </div>
                </div>

                <!-- Maintenance Role -->
                <div class="card" style="margin-bottom: 1.5rem; background: var(--warning-light); padding: 1.5rem;">
                  <h4 style="margin: 0 0 1rem 0; color: var(--warning);">üîß Maintenance</h4>
                  <p style="margin: 0 0 1rem 0; color: var(--text-secondary);">
                    Maintenance staff with access to inventory and work orders for assigned properties.
                  </p>
                  <div style="display: grid; gap: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>View inventory for assigned properties</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>Add new inventory items</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>Request quotes from vendors</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--danger); font-size: 1.25rem;">‚úó</span>
                      <span style="opacity: 0.6;">Cannot delete inventory or invoices</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--danger); font-size: 1.25rem;">‚úó</span>
                      <span style="opacity: 0.6;">Cannot manage employees</span>
                    </div>
                  </div>
                </div>

                <!-- Leasing Role -->
                <div class="card" style="margin-bottom: 1.5rem; background: var(--success-light); padding: 1.5rem;">
                  <h4 style="margin: 0 0 1rem 0; color: var(--success);">üìã Leasing</h4>
                  <p style="margin: 0 0 1rem 0; color: var(--text-secondary);">
                    Leasing agents with read-only access to property information and reports.
                  </p>
                  <div style="display: grid; gap: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>View inventory for assigned properties</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--success); font-size: 1.25rem;">‚úì</span>
                      <span>View reports and invoices</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--danger); font-size: 1.25rem;">‚úó</span>
                      <span style="opacity: 0.6;">Cannot add, edit, or delete data</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="color: var(--danger); font-size: 1.25rem;">‚úó</span>
                      <span style="opacity: 0.6;">Cannot manage employees</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quotes Page -->
        <div id="quotesPage" class="page">
          <div class="card">
            <h3>üí∞ Vendor Quote Comparison</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
              ü§ñ <strong>Automatic Quote Fetching:</strong> Request quotes and the system automatically logs into your saved vendors, pulls real prices, and compares them instantly. No manual fetching needed!
            </p>

            <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
              <button class="btn-primary" onclick="showVendorCredentials()">üîë Manage Vendor Logins</button>
              <button class="btn-primary" onclick="showNewQuoteRequest()">‚ûï New Quote Request</button>
            </div>

            <!-- Vendor Credentials Section -->
            <div id="vendorCredentialsSection" style="display: none;">
              <h4 style="margin-bottom: 1rem;">Vendor Login Credentials</h4>
              <div id="vendorCredentialsList"></div>

              <h4 style="margin-top: 2rem; margin-bottom: 1rem;">Add New Vendor</h4>
              <form id="addVendorForm" onsubmit="addVendorCredential(event)" style="display: grid; gap: 1rem;">
                <div>
                  <label>Vendor Name</label>
                  <select id="newVendorName" class="form-input" required>
                    <option value="">Select vendor...</option>
                    <option value="Home Depot">Home Depot</option>
                    <option value="Lowe's">Lowe's</option>
                    <option value="Grainger">Grainger</option>
                    <option value="Ferguson">Ferguson</option>
                    <option value="Fastenal">Fastenal</option>
                    <option value="Menards">Menards</option>
                  </select>
                </div>
                <div>
                  <label>Vendor URL</label>
                  <input type="url" id="newVendorUrl" class="form-input" placeholder="https://www.homedepot.com" required />
                </div>
                <div>
                  <label>Your Username/Email</label>
                  <input type="text" id="newVendorUsername" class="form-input" required />
                </div>
                <div>
                  <label>Your Password</label>
                  <input type="password" id="newVendorPassword" class="form-input" required />
                  <p style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">
                    üîí Your password is encrypted and stored securely
                  </p>
                </div>
                <div>
                  <label>Property (Optional)</label>
                  <select id="newVendorProperty" class="form-input">
                    <option value="">All Properties</option>
                  </select>
                </div>
                <div style="display: flex; gap: 1rem;">
                  <button type="submit" class="btn-primary">Save Credentials</button>
                  <button type="button" class="btn-secondary" onclick="hideVendorCredentials()">Cancel</button>
                </div>
              </form>
            </div>

            <!-- New Quote Request Form -->
            <div id="newQuoteRequestSection" style="display: none;">
              <h4 style="margin-bottom: 1rem;">Request New Quote</h4>
              <form id="newQuoteForm" onsubmit="createQuoteRequest(event)" style="display: grid; gap: 1rem;">
                <div>
                  <label>What do you need a quote for?</label>
                  <input type="text" id="quoteItemDescription" class="form-input"
                         placeholder="e.g., Ceiling fan, LED light bulbs, Paint, etc." required />
                </div>
                <div>
                  <label>Quantity</label>
                  <input type="number" id="quoteQuantity" class="form-input" value="1" min="1" required />
                </div>
                <div>
                  <label>Property (Optional)</label>
                  <select id="quoteProperty" class="form-input">
                    <option value="">Select property...</option>
                  </select>
                </div>
                <div>
                  <label>Notes (Optional)</label>
                  <textarea id="quoteNotes" class="form-input" rows="3"
                            placeholder="Any specific requirements or details..."></textarea>
                </div>
                <div style="display: flex; gap: 1rem;">
                  <button type="submit" class="btn-primary">Create & Fetch Quotes</button>
                  <button type="button" class="btn-secondary" onclick="hideNewQuoteRequest()">Cancel</button>
                </div>
              </form>
            </div>

            <!-- Quote Requests List -->
            <div id="quoteRequestsList">
              <h4 style="margin-top: 2rem; margin-bottom: 1rem;">Your Quote Requests</h4>
              <div id="quoteRequestsContent"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global state
      let currentUser = null;
      let currentInvPage = 1;
      let properties = [];

      // Custom Modal System
      let modalAutoCloseTimer = null;
      let modalResolve = null;

      function showModal(message, type = 'info', title = null, autoDismiss = true, showCancel = false, showInput = false, defaultValue = '') {
        return new Promise((resolve) => {
          const overlay = document.getElementById('customModalOverlay');
          const icon = document.getElementById('customModalIcon');
          const titleEl = document.getElementById('customModalTitle');
          const messageEl = document.getElementById('customModalMessage');
          const btn = document.getElementById('customModalBtn');
          const cancelBtn = document.getElementById('customModalCancelBtn');
          const inputEl = document.getElementById('customModalInput');

          // Clear any existing auto-close timer
          if (modalAutoCloseTimer) {
            clearTimeout(modalAutoCloseTimer);
            modalAutoCloseTimer = null;
          }

          // Set icon and title based on type
          const config = {
            success: { icon: '‚úì', title: 'Success', class: 'success', duration: 3000 },
            error: { icon: '‚úï', title: 'Error', class: 'error', duration: 5000 },
            warning: { icon: '‚ö†', title: 'Warning', class: 'warning', duration: 4000 },
            info: { icon: '‚Ñπ', title: 'Information', class: 'info', duration: 3000 },
            confirm: { icon: '?', title: 'Confirm', class: 'warning', duration: 0 },
            prompt: { icon: '‚úè', title: 'Input Required', class: 'info', duration: 0 }
          };

          const modalConfig = config[type] || config.info;

          // Update icon
          icon.textContent = modalConfig.icon;
          icon.className = 'custom-modal-icon ' + modalConfig.class;

          // Update title
          titleEl.textContent = title || modalConfig.title;

          // Update message
          messageEl.textContent = message;

          // Show/hide input field
          if (showInput) {
            inputEl.style.display = 'block';
            inputEl.value = defaultValue;
            cancelBtn.style.display = 'inline-block';
            autoDismiss = false;
            // Focus input after a brief delay to ensure modal is visible
            setTimeout(() => inputEl.focus(), 100);
          } else {
            inputEl.style.display = 'none';
            inputEl.value = '';
          }

          // Show/hide cancel button
          if (showCancel) {
            cancelBtn.style.display = 'inline-block';
            autoDismiss = false; // Don't auto-dismiss confirm/prompt dialogs
          } else if (!showInput) {
            cancelBtn.style.display = 'none';
          }

          // Show modal
          overlay.classList.add('active');

          // Function to close modal
          const closeModal = (result = true) => {
            overlay.classList.remove('active');
            if (modalAutoCloseTimer) {
              clearTimeout(modalAutoCloseTimer);
              modalAutoCloseTimer = null;
            }
            // Remove event listeners
            overlay.onclick = null;

            // Return input value for prompts, boolean for confirms, undefined for alerts
            if (showInput) {
              resolve(result ? inputEl.value : null);
            } else {
              resolve(result);
            }
          };

          // Close on OK button click
          btn.onclick = () => closeModal(true);

          // Close on Cancel button click
          cancelBtn.onclick = () => closeModal(false);

          // Close on overlay click (only for non-confirm/prompt dialogs)
          overlay.onclick = (e) => {
            if (e.target === overlay && !showCancel && !showInput) {
              closeModal(true);
            }
          };

          // Close on Escape key
          const escHandler = (e) => {
            if (e.key === 'Escape') {
              closeModal((showCancel || showInput) ? false : true);
              document.removeEventListener('keydown', escHandler);
            } else if (e.key === 'Enter' && showInput) {
              // Submit on Enter for prompts
              closeModal(true);
              document.removeEventListener('keydown', escHandler);
            }
          };
          document.addEventListener('keydown', escHandler);

          // Auto-dismiss after duration (longer for errors so user can read them)
          if (autoDismiss && modalConfig.duration > 0) {
            modalAutoCloseTimer = setTimeout(() => {
              closeModal(true);
              document.removeEventListener('keydown', escHandler);
            }, modalConfig.duration);
          }
        });
      }

      // Override alert to use custom modal
      const originalAlert = window.alert;
      window.alert = function(message) {
        // Determine type based on message content
        let type = 'info';
        if (message.toLowerCase().includes('success') || message.toLowerCase().includes('created') || message.toLowerCase().includes('deleted')) {
          type = 'success';
        } else if (message.toLowerCase().includes('error') || message.toLowerCase().includes('failed')) {
          type = 'error';
        } else if (message.toLowerCase().includes('warning') || message.toLowerCase().includes('sure')) {
          type = 'warning';
        }

        showModal(message, type);
      };

      // Override confirm to use custom modal
      const originalConfirm = window.confirm;
      window.confirm = function(message) {
        // Return the promise directly - it will resolve to true/false
        return showModal(message, 'confirm', 'Confirm', false, true, false);
      };

      // Override prompt to use custom modal
      const originalPrompt = window.prompt;
      window.prompt = function(message, defaultValue = '') {
        // Return the promise directly - it will resolve to input value or null
        return showModal(message, 'prompt', 'Input Required', false, false, true, defaultValue);
      };

      // Auth functions
      async function doLogin() {
        const email = document.getElementById('login_email').value;
        const password = document.getElementById('login_password').value;
        const msgEl = document.getElementById('loginMsg');

        if (!email || !password) {
          msgEl.innerHTML = '<div class="alert danger">Please enter email and password</div>';
          return;
        }

        const fd = new URLSearchParams();
        fd.append('username', email);
        fd.append('password', password);

        try {
          const res = await fetch('/api/auth/login', { method: 'POST', body: fd });
          const data = await res.json();

          if (res.ok && data.access_token) {
            localStorage.setItem('bb_token', data.access_token);
            msgEl.innerHTML = '<div class="alert success">Logged in successfully!</div>';
            setTimeout(() => {
              showMainApp();
              resetInactivityTimer(); // Start inactivity timer after login
            }, 500);
          } else {
            msgEl.innerHTML = `<div class="alert danger">${data.detail || 'Login failed'}</div>`;
          }
        } catch (e) {
          msgEl.innerHTML = `<div class="alert danger">Error: ${e.message}</div>`;
        }
      }

      async function doSignup() {
        const email = document.getElementById('login_email').value;
        const password = document.getElementById('login_password').value;
        const msgEl = document.getElementById('loginMsg');

        if (!email || !password) {
          msgEl.innerHTML = '<div class="alert danger">Please enter email and password</div>';
          return;
        }

        // Ask for company name
        const companyName = await prompt('What is your company/organization name?\n\n(This will create a new organization. Leave empty to join an existing one if invited.)');

        const fd = new URLSearchParams();
        fd.append('name', email.split('@')[0] || email);
        fd.append('email', email);
        fd.append('password', password);
        fd.append('role', 'manager');

        if (companyName && companyName.trim()) {
          fd.append('company_name', companyName.trim());
        }

        try {
          const res = await fetch('/api/auth/signup', { method: 'POST', body: fd });
          const data = await res.json();

          if (res.ok && data.access_token) {
            localStorage.setItem('bb_token', data.access_token);
            msgEl.innerHTML = '<div class="alert success">Account created successfully!</div>';
            setTimeout(() => {
              showMainApp();
              resetInactivityTimer(); // Start inactivity timer after signup
            }, 500);
          } else {
            msgEl.innerHTML = `<div class="alert danger">${data.detail || 'Signup failed'}</div>`;
          }
        } catch (e) {
          msgEl.innerHTML = `<div class="alert danger">Error: ${e.message}</div>`;
        }
      }

      // Auto-logout after 30 minutes of inactivity
      let inactivityTimer;
      const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes in milliseconds

      function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
          const token = localStorage.getItem('bb_token');
          if (token) {
            alert('You have been logged out due to inactivity.');
            logout();
          }
        }, INACTIVITY_TIMEOUT);
      }

      function logout() {
        clearTimeout(inactivityTimer);
        localStorage.removeItem('bb_token');
        document.getElementById('loginScreen').classList.add('active');
        document.getElementById('mainApp').classList.remove('active');
        document.getElementById('login_email').value = '';
        document.getElementById('login_password').value = '';
        document.getElementById('loginMsg').innerHTML = '';

        // Hide AI chat widget
        const chatWidget = document.getElementById('aiChatWidget');
        if (chatWidget) {
          chatWidget.classList.remove('visible');
        }
      }

      function authHeaders() {
        const token = localStorage.getItem('bb_token');
        return token ? { 'Authorization': 'Bearer ' + token } : {};
      }

      // Show main app
      async function showMainApp() {
        console.log('=== showMainApp called ===');
        const loginScreen = document.getElementById('loginScreen');
        const mainApp = document.getElementById('mainApp');

        console.log('Before changes:');
        console.log('- loginScreen classes:', loginScreen.className);
        console.log('- mainApp classes:', mainApp.className);

        // Hide login screen
        loginScreen.classList.remove('active');
        console.log('Removed active from loginScreen');

        // Show main app
        mainApp.classList.add('active');
        console.log('Added active to mainApp');

        // Show AI chat widget
        const chatWidget = document.getElementById('aiChatWidget');
        if (chatWidget) {
          chatWidget.classList.add('visible');
        }

        console.log('After changes:');
        console.log('- loginScreen classes:', loginScreen.className);
        console.log('- mainApp classes:', mainApp.className);
        console.log('- loginScreen computed display:', window.getComputedStyle(loginScreen).display);
        console.log('- mainApp computed display:', window.getComputedStyle(mainApp).display);

        // Load data
        await loadCurrentUser();
        await fetchProperties();
        await refreshStats();

        // Show dashboard page
        showPage('dashboard');
        console.log('=== Dashboard page activated ===');
      }

      // Page navigation
      function showPage(pageName) {
        console.log('=== showPage called with:', pageName, '===');

        // Hide all pages inside mainApp
        const allPages = document.querySelectorAll('#mainApp .page');
        console.log('Found', allPages.length, 'pages inside mainApp');
        allPages.forEach(p => {
          p.classList.remove('active');
          console.log('- Removed active from:', p.id);
        });

        // Show selected page
        const pageId = pageName + 'Page';
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
          targetPage.classList.add('active');
          console.log('- Added active to:', pageId);
          console.log('- Page computed display:', window.getComputedStyle(targetPage).display);
        } else {
          console.error('‚ùå Page not found:', pageId);
        }

        // Update nav tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
          tab.classList.remove('active');
        });

        // Only try to set active tab if there's an event
        if (typeof event !== 'undefined' && event && event.target) {
          const clickedTab = event.target.closest('.nav-tab');
          if (clickedTab) {
            clickedTab.classList.add('active');
          }
        } else {
          // Set the first tab (dashboard) as active by default
          const dashboardTab = document.querySelector('.nav-tab');
          if (dashboardTab) {
            dashboardTab.classList.add('active');
          }
        }

        // Load page-specific data
        if (pageName === 'inventory') {
          loadInventory(1);
        } else if (pageName === 'properties') {
          renderProperties();
        } else if (pageName === 'invoices') {
          populatePropertySelect('invoicePropertySelect');
        } else if (pageName === 'quotes') {
          loadQuoteRequests();
        } else if (pageName === 'settings') {
          loadUserSettings();
        }
      }

      // Load current user
      async function loadCurrentUser() {
        const token = localStorage.getItem('bb_token');
        if (!token) return;

        try {
          const res = await fetch('/api/auth/me', { headers: authHeaders() });
          if (!res.ok) {
            document.getElementById('currentUserInfo').innerHTML = '<em class="text-muted">Not logged in</em>';
            return;
          }

          currentUser = await res.json();
          let html = `
            <p><strong>Name:</strong> ${currentUser.name}</p>
            <p><strong>Email:</strong> ${currentUser.email}</p>
            <p><strong>Role:</strong> <span class="badge">${currentUser.role}</span></p>
          `;

          if (currentUser.current_property_id) {
            html += `<p><strong>Property ID:</strong> ${currentUser.current_property_id}</p>`;
          } else {
            html += `<p><em class="text-muted">No property assigned</em></p>`;
          }

          document.getElementById('currentUserInfo').innerHTML = html;
          document.getElementById('userSettingsInfo').innerHTML = html;

          // Show/hide admin sections
          const isAdmin = currentUser.role === 'admin';
          const adminSections = ['adminAddProperty', 'adminDeleteProperty', 'adminUserManagement'];
          adminSections.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = isAdmin ? 'block' : 'none';
          });
        } catch (e) {
          console.error('Error loading user:', e);
        }
      }

      // Fetch properties
      async function fetchProperties() {
        try {
          const res = await fetch('/api/properties', { headers: authHeaders() });
          properties = await res.json();

          // Update stats
          document.getElementById('statActiveProperties').textContent = properties.length;

          // Populate delete select
          populateDeleteSelect();
        } catch (e) {
          console.error('Error fetching properties:', e);
        }
      }

      // Render properties
      function renderProperties() {
        const container = document.getElementById('propertiesGrid');
        container.innerHTML = '';

        for (let i = 0; i < 9; i++) {
          const prop = properties[i];
          const slot = document.createElement('div');
          slot.className = 'property-slot' + (prop ? ' filled' : '');

          if (prop) {
            slot.innerHTML = `
              <div class="property-name">${prop.name}</div>
              <div class="property-address">${prop.address || 'No address'}</div>
              <span class="badge">Property #${prop.id}</span>
            `;
          } else {
            slot.innerHTML = `
              <div class="property-name text-muted">Empty Slot ${i + 1}</div>
              <div class="property-address">Available for new property</div>
            `;
          }

          container.appendChild(slot);
        }
      }

      // Create property
      async function createProperty() {
        const name = document.getElementById('newPropName').value.trim();
        const address = document.getElementById('newPropAddress').value.trim();

        if (!name) {
          alert('Please enter a property name');
          return;
        }

        const fd = new URLSearchParams();
        fd.append('name', name);
        fd.append('address', address);

        try {
          const res = await fetch('/api/properties', {
            method: 'POST',
            headers: authHeaders(),
            body: fd
          });

          if (res.ok) {
            alert('Property created successfully!');
            document.getElementById('newPropName').value = '';
            document.getElementById('newPropAddress').value = '';
            await fetchProperties();
            renderProperties();
          } else {
            const data = await res.json();
            alert(data.detail || 'Error creating property');
          }
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }

      // Delete property
      async function deleteProperty() {
        const select = document.getElementById('deletePropertySelect');
        const id = select.value;

        if (!id) {
          alert('Please select a property');
          return;
        }

        if (!await confirm('Are you sure you want to delete this property?')) {
          return;
        }

        try {
          const res = await fetch(`/api/properties/${id}`, {
            method: 'DELETE',
            headers: authHeaders()
          });

          if (res.ok) {
            alert('Property deleted successfully!');
            await fetchProperties();
            renderProperties();
          } else {
            const data = await res.json();
            alert(data.detail || 'Error deleting property');
          }
        } catch (e) {
          alert('Error: ' + e.message);
        }
      }

      // Populate delete select
      function populateDeleteSelect() {
        const select = document.getElementById('deletePropertySelect');
        select.innerHTML = '<option value="">Select a property...</option>';

        properties.forEach(p => {
          const option = document.createElement('option');
          option.value = p.id;
          option.textContent = p.name;
          select.appendChild(option);
        });
      }

      // Populate property select for invoices
      function populatePropertySelect(selectId) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Select property...</option>';

        properties.forEach(p => {
          const option = document.createElement('option');
          option.value = p.id;
          option.textContent = p.name;
          select.appendChild(option);
        });
      }

      // Inventory functions
      async function loadInventory(page) {
        currentInvPage = page || currentInvPage;
        const per = document.getElementById('inv_per').value || 10;
        const prop = document.getElementById('inv_prop').value;

        const params = new URLSearchParams();
        params.set('page', currentInvPage);
        params.set('per_page', per);
        if (prop) params.set('property_id', prop);

        try {
          const res = await fetch('/api/inventory?' + params.toString(), { headers: authHeaders() });
          const data = await res.json();

          document.getElementById('invPage').textContent = data.page;

          const table = document.getElementById('invTable');
          if (!data.items || data.items.length === 0) {
            table.innerHTML = '<em class="text-muted">No items found</em>';
            return;
          }

          let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Quantity</th><th>Cost</th><th>Property</th></tr></thead><tbody>';

          data.items.forEach(item => {
            html += `
              <tr>
                <td>${item.id}</td>
                <td><strong>${item.name}</strong></td>
                <td>${item.description || '-'}</td>
                <td>${item.quantity}</td>
                <td>$${item.cost.toFixed(2)}</td>
                <td>${item.property_id}</td>
              </tr>
            `;
          });

          html += '</tbody></table>';
          table.innerHTML = html;

          // Update total items stat
          document.getElementById('statTotalItems').textContent = data.total;
        } catch (e) {
          console.error('Error loading inventory:', e);
          document.getElementById('invTable').innerHTML = `<em class="text-muted">Error: ${e.message}</em>`;
        }
      }

      function prevPage() {
        if (currentInvPage > 1) {
          currentInvPage--;
          loadInventory(currentInvPage);
        }
      }

      function nextPage() {
        currentInvPage++;
        loadInventory(currentInvPage);
      }

      // Add inventory item
      async function addInventoryItem() {
        const name = document.getElementById('new_inv_name').value.trim();
        const desc = document.getElementById('new_inv_desc').value.trim();
        const qty = document.getElementById('new_inv_qty').value;
        const cost = document.getElementById('new_inv_cost').value;
        const propId = document.getElementById('new_inv_prop').value;
        const resultEl = document.getElementById('addInvResult');

        if (!name || !propId) {
          resultEl.innerHTML = '<div class="alert danger">Name and Property ID are required</div>';
          return;
        }

        const fd = new URLSearchParams();
        fd.append('property_id', propId);
        fd.append('name', name);
        fd.append('description', desc);
        fd.append('quantity', qty || 1);
        fd.append('cost', cost || 0);

        try {
          const res = await fetch('/api/inventory', {
            method: 'POST',
            headers: authHeaders(),
            body: fd
          });

          if (res.ok) {
            const item = await res.json();
            resultEl.innerHTML = '<div class="alert success">Item added successfully!</div>';
            document.getElementById('new_inv_name').value = '';
            document.getElementById('new_inv_desc').value = '';
            document.getElementById('new_inv_qty').value = '1';
            document.getElementById('new_inv_cost').value = '0.00';
            loadInventory(1);
          } else {
            const data = await res.json();
            resultEl.innerHTML = `<div class="alert danger">${data.detail || 'Error adding item'}</div>`;
          }
        } catch (e) {
          resultEl.innerHTML = `<div class="alert danger">Error: ${e.message}</div>`;
        }
      }

      // Upload CSV
      async function uploadCSV() {
        const file = document.getElementById('csvFile').files[0];
        const propId = document.getElementById('invoicePropertySelect').value;
        const resultEl = document.getElementById('importResult');

        if (!file || !propId) {
          resultEl.innerHTML = '<div class="alert danger">Please select both a CSV file and a property</div>';
          return;
        }

        const fd = new FormData();
        fd.append('file', file);
        fd.append('property_id', propId);

        try {
          const res = await fetch('/api/import-invoices', {
            method: 'POST',
            headers: authHeaders(),
            body: fd
          });

          const data = await res.json();

          if (res.ok) {
            resultEl.innerHTML = `<div class="alert success">‚úì Imported ${data.imported} invoices successfully! Checking for auto-quotable items...</div>`;
            refreshStats();

            // Check for auto-generated quotes for each imported invoice
            if (data.items && data.items.length > 0) {
              // Wait a moment for auto-quote generation to complete
              setTimeout(async () => {
                await checkInvoiceQuotes(data.items);
              }, 1000);
            }
          } else {
            resultEl.innerHTML = `<div class="alert danger">${data.detail || 'Import failed'}</div>`;
          }
        } catch (e) {
          resultEl.innerHTML = `<div class="alert danger">Error: ${e.message}</div>`;
        }
      }

      async function checkInvoiceQuotes(importedInvoices) {
        let totalQuotes = 0;
        let allQuoteRequests = [];

        for (const invoice of importedInvoices) {
          try {
            const res = await fetch(`/api/invoices/${invoice.id}/quotes`, {
              headers: authHeaders()
            });

            if (res.ok) {
              const data = await res.json();
              if (data.quote_requests && data.quote_requests.length > 0) {
                totalQuotes += data.quote_requests.length;
                allQuoteRequests.push(...data.quote_requests.map(qr => ({
                  ...qr,
                  invoice_id: invoice.id
                })));
              }
            }
          } catch (e) {
            console.error(`Error checking quotes for invoice ${invoice.id}:`, e);
          }
        }

        if (totalQuotes > 0) {
          displayAutoGeneratedQuotes(allQuoteRequests);
        } else {
          document.getElementById('importResult').innerHTML += `
            <div class="alert info" style="margin-top: 1rem;">
              No reorderable items detected in these invoices.
            </div>
          `;
        }
      }

      function displayAutoGeneratedQuotes(quoteRequests) {
        document.getElementById('autoQuotesSection').style.display = 'block';

        let html = `<div class="alert success" style="margin-bottom: 1rem;">
          üéâ Found ${quoteRequests.length} reorderable ${quoteRequests.length === 1 ? 'item' : 'items'}! Quote requests created automatically.
        </div>`;

        html += '<div style="display: grid; gap: 1rem;">';

        quoteRequests.forEach(qr => {
          const statusColor = qr.status === 'completed' ? 'success' :
                             qr.status === 'failed' ? 'danger' :
                             qr.status === 'fetching' ? 'warning' : 'info';

          html += `
            <div class="card" style="padding: 1.5rem; cursor: pointer;" onclick="viewQuoteDetails(${qr.quote_request_id})">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div style="flex: 1;">
                  <h4 style="margin: 0 0 0.5rem 0;">${qr.item_description}</h4>
                  <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem;">
                    Quantity: ${qr.quantity} | ${qr.quote_count} ${qr.quote_count === 1 ? 'quote' : 'quotes'} found
                  </p>
                </div>
                <span class="badge ${statusColor}">${qr.status.toUpperCase()}</span>
              </div>

              ${qr.quote_count > 0 ? `
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                  ${qr.quotes.map(q => `
                    <div style="background: var(--success-light); padding: 0.75rem 1rem; border-radius: 8px;">
                      <strong>${q.vendor_name}</strong>
                      <p style="margin: 0.25rem 0 0 0; font-size: 1.25rem; font-weight: bold; color: var(--success);">
                        $${q.total_price.toFixed(2)}
                      </p>
                    </div>
                  `).join('')}
                </div>
              ` : `
                <button class="btn-primary" onclick="event.stopPropagation(); fetchQuotesForRequest(${qr.quote_request_id})"
                        style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                  Fetch Quotes Now
                </button>
              `}
            </div>
          `;
        });

        html += '</div>';

        html += `
          <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--card-border);">
            <p style="margin-bottom: 1rem;"><strong>Next Steps:</strong></p>
            <ul style="margin: 0; padding-left: 1.5rem;">
              <li>Click any item above to view full quote comparison</li>
              <li>Visit the <button class="btn-secondary" onclick="showPage('quotes')" style="padding: 0.25rem 0.75rem; font-size: 0.875rem; display: inline;">Quotes</button> page to manage all quotes</li>
              <li>Generate email-ready reports to send to approvers</li>
            </ul>
          </div>
        `;

        document.getElementById('autoQuotesList').innerHTML = html;
      }

      function hideAutoQuotes() {
        document.getElementById('autoQuotesSection').style.display = 'none';
      }

      // Reports
      async function getMonthlyReport() {
        const year = document.getElementById('r_month_year').value;
        const month = document.getElementById('r_month').value;
        const propId = document.getElementById('r_month_prop').value;
        const resultEl = document.getElementById('monthlyResult');

        if (!year || !month) {
          resultEl.textContent = 'Please enter year and month';
          return;
        }

        const params = new URLSearchParams();
        params.set('year', year);
        params.set('month', month);
        if (propId) params.set('property_id', propId);

        try {
          const res = await fetch('/api/reports/monthly?' + params.toString(), { headers: authHeaders() });
          const data = await res.json();
          resultEl.textContent = JSON.stringify(data, null, 2);
        } catch (e) {
          resultEl.textContent = 'Error: ' + e.message;
        }
      }

      async function getYearlyReport() {
        const year = document.getElementById('r_yearly_year').value;
        const propId = document.getElementById('r_yearly_prop').value;
        const resultEl = document.getElementById('yearlyResult');

        if (!year) {
          resultEl.textContent = 'Please enter year';
          return;
        }

        const params = new URLSearchParams();
        params.set('year', year);
        if (propId) params.set('property_id', propId);

        try {
          const res = await fetch('/api/reports/yearly?' + params.toString(), { headers: authHeaders() });
          const data = await res.json();
          resultEl.textContent = JSON.stringify(data, null, 2);
        } catch (e) {
          resultEl.textContent = 'Error: ' + e.message;
        }
      }

      // Refresh stats
      async function refreshStats() {
        try {
          // Total items
          const invRes = await fetch('/api/inventory?per_page=1&page=1', { headers: authHeaders() });
          if (invRes.ok) {
            const inv = await invRes.json();
            document.getElementById('statTotalItems').textContent = inv.total ?? 0;
          }

          // Total spent (current year)
          const year = new Date().getFullYear();
          const repRes = await fetch(`/api/reports/yearly?year=${year}`, { headers: authHeaders() });
          if (repRes.ok) {
            const rep = await repRes.json();
            document.getElementById('statTotalSpent').textContent = '$' + (rep.total || 0).toFixed(2);
          }

          // Properties count
          document.getElementById('statActiveProperties').textContent = properties.length;
        } catch (e) {
          console.error('Error refreshing stats:', e);
        }
      }

      // Settings
      function toggleDarkMode() {
        const isDark = document.getElementById('darkModeToggle').checked;
        document.body.classList.toggle('dark-mode', isDark);
        localStorage.setItem('darkMode', isDark);
      }

      function initDarkMode() {
        const isDark = localStorage.getItem('darkMode') === 'true';
        document.getElementById('darkModeToggle').checked = isDark;
        document.body.classList.toggle('dark-mode', isDark);
      }

      async function loadUserSettings() {
        // User info is already loaded in currentUser
        if (currentUser) {
          let html = `
            <p><strong>Name:</strong> ${currentUser.name}</p>
            <p><strong>Email:</strong> ${currentUser.email}</p>
            <p><strong>Role:</strong> <span class="badge">${currentUser.role}</span></p>
          `;

          if (currentUser.current_property_id) {
            html += `<p><strong>Property ID:</strong> ${currentUser.current_property_id}</p>`;
          } else {
            html += `<p><em class="text-muted">No property assigned</em></p>`;
          }

          document.getElementById('userSettingsInfo').innerHTML = html;

          // Load user management for admins
          if (currentUser.role === 'admin') {
            await loadUserManagement();
          }
        }
      }

      // User Management Tab Switching
      function showUserManagementTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.user-mgmt-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        event.target.closest('.user-mgmt-tab').classList.add('active');

        // Update tab content
        document.querySelectorAll('.user-mgmt-tab-content').forEach(content => {
          content.style.display = 'none';
        });

        if (tabName === 'employees') {
          document.getElementById('employeesTab').style.display = 'block';
          loadEmployees();
        } else if (tabName === 'roles') {
          document.getElementById('rolesTab').style.display = 'block';
        }
      }

      let allEmployees = [];

      async function loadEmployees() {
        try {
          const res = await fetch('/api/users', { headers: authHeaders() });
          allEmployees = await res.json();

          // Load property access for each employee
          for (const emp of allEmployees) {
            const accessRes = await fetch(`/api/users/${emp.id}/properties`, { headers: authHeaders() });
            emp.properties = await accessRes.json();
          }

          displayEmployees(allEmployees);
        } catch (e) {
          console.error('Error loading employees:', e);
          document.getElementById('employeesList').innerHTML = '<p class="alert danger">Failed to load employees</p>';
        }
      }

      function filterEmployees() {
        const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
        const filtered = allEmployees.filter(emp =>
          emp.name.toLowerCase().includes(searchTerm) ||
          emp.email.toLowerCase().includes(searchTerm) ||
          emp.role.toLowerCase().includes(searchTerm)
        );
        displayEmployees(filtered);
      }

      function displayEmployees(employees) {
        const container = document.getElementById('employeesList');

        if (employees.length === 0) {
          container.innerHTML = '<p style="color: var(--text-muted);">No employees found.</p>';
          return;
        }

        let html = '<div style="display: grid; gap: 1rem;">';

        employees.forEach(emp => {
          const roleIcon = {
            'admin': 'üîë',
            'manager': 'üë®‚Äçüíº',
            'maintenance': 'üîß',
            'leasing': 'üìã'
          }[emp.role] || 'üë§';

          const propertyCount = emp.properties?.length || 0;

          html += `
            <div class="employee-card" onclick="openEmployeeModal(${emp.id})">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                    <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                      ${roleIcon}
                    </div>
                    <div>
                      <h4 style="margin: 0; color: var(--text-primary);">${emp.name}</h4>
                      <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.875rem;">${emp.email}</p>
                    </div>
                  </div>
                  <div style="display: flex; gap: 1rem; align-items: center;">
                    <span class="employee-role-badge ${emp.role}">${emp.role}</span>
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">
                      üè† ${propertyCount} ${propertyCount === 1 ? 'property' : 'properties'}
                    </span>
                  </div>
                </div>
                <button class="btn-secondary" onclick="event.stopPropagation(); openEmployeeModal(${emp.id})"
                        style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                  View Details ‚Üí
                </button>
              </div>
            </div>
          `;
        });

        html += '</div>';
        container.innerHTML = html;
      }

      async function openEmployeeModal(employeeId) {
        const employee = allEmployees.find(e => e.id === employeeId);
        if (!employee) return;

        const roleIcon = {
          'admin': 'üîë',
          'manager': 'üë®‚Äçüíº',
          'maintenance': 'üîß',
          'leasing': 'üìã'
        }[employee.role] || 'üë§';

        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 20000;';
        modal.onclick = (e) => {  if (e.target === modal) modal.remove(); };

        let html = `
          <div class="card" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 2rem;" onclick="event.stopPropagation();">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 2px solid var(--card-border);">
              <div style="width: 64px; height: 64px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                ${roleIcon}
              </div>
              <div style="flex: 1;">
                <h3 style="margin: 0;">${employee.name}</h3>
                <p style="margin: 0.25rem 0; color: var(--text-secondary);">${employee.email}</p>
                <span class="employee-role-badge ${employee.role}" style="display: inline-block; margin-top: 0.5rem;">${employee.role}</span>
              </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0;">Change Role</h4>
              <select id="employeeRoleSelect" class="form-input">
                <option value="admin" ${employee.role === 'admin' ? 'selected' : ''}>Admin</option>
                <option value="manager" ${employee.role === 'manager' ? 'selected' : ''}>Manager</option>
                <option value="maintenance" ${employee.role === 'maintenance' ? 'selected' : ''}>Maintenance</option>
                <option value="leasing" ${employee.role === 'leasing' ? 'selected' : ''}>Leasing</option>
              </select>
              <button class="btn-primary" onclick="changeEmployeeRole(${employee.id})" style="width: 100%; margin-top: 0.5rem;">
                Update Role
              </button>
            </div>

            <div style="margin-bottom: 1.5rem;">
              <h4 style="margin: 0 0 1rem 0;">Property Access (${employee.properties?.length || 0})</h4>
        `;

        if (employee.properties && employee.properties.length > 0) {
          html += '<div style="display: grid; gap: 0.75rem;">';
          employee.properties.forEach(prop => {
            const permissions = [];
            if (prop.can_view) permissions.push('View');
            if (prop.can_edit) permissions.push('Edit');
            if (prop.can_delete) permissions.push('Delete');

            html += `
              <div style="background: var(--bg-gradient-start); border: 1px solid var(--card-border); border-radius: 8px; padding: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div>
                    <strong>${prop.name}</strong>
                    ${prop.address ? `<p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.875rem;">${prop.address}</p>` : ''}
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                      <strong>Permissions:</strong> ${permissions.join(', ')}
                    </p>
                  </div>
                  <button class="btn-danger" onclick="removePropertyAccess(${employee.id}, ${prop.id})"
                          style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                    Remove
                  </button>
                </div>
              </div>
            `;
          });
          html += '</div>';
        } else {
          html += '<p style="color: var(--text-muted); font-style: italic;">No property access assigned yet.</p>';
        }

        html += `
              <button class="btn-primary" onclick="showAddPropertyAccessModal(${employee.id})" style="width: 100%; margin-top: 1rem;">
                + Grant Property Access
              </button>
            </div>

            <div style="padding-top: 1.5rem; border-top: 2px solid var(--card-border);">
              <button class="btn-danger" onclick="deleteEmployee(${employee.id}, '${employee.name}')" style="width: 100%;">
                üóëÔ∏è Delete Employee & Remove Login
              </button>
              <button class="btn-secondary" onclick="this.closest('[style*=fixed]').remove()" style="width: 100%; margin-top: 0.5rem;">
                Close
              </button>
            </div>
          </div>
        `;

        modal.innerHTML = html;
        document.body.appendChild(modal);
      }

      async function changeEmployeeRole(employeeId) {
        const newRole = document.getElementById('employeeRoleSelect').value;

        try {
          const fd = new FormData();
          fd.append('role', newRole);

          const res = await fetch(`/api/users/${employeeId}/role`, {
            method: 'POST',
            headers: authHeaders(),
            body: fd
          });

          if (res.ok) {
            alert('Role updated successfully!');
            await loadEmployees();
            document.querySelector('[style*="position: fixed"]').remove();
          } else {
            const data = await res.json();
            alert(`Failed to update role: ${data.detail || 'Unknown error'}`);
          }
        } catch (e) {
          alert(`Error: ${e.message}`);
        }
      }

      async function removePropertyAccess(employeeId, propertyId) {
        if (!await confirm('Remove this property access?')) return;

        try {
          const res = await fetch(`/api/users/${employeeId}/properties/${propertyId}/revoke`, {
            method: 'POST',
            headers: authHeaders()
          });

          if (res.ok) {
            alert('Property access removed successfully!');
            await loadEmployees();
            document.querySelector('[style*="position: fixed"]').remove();
          } else {
            const data = await res.json();
            alert(`Failed to remove access: ${data.detail || 'Unknown error'}`);
          }
        } catch (e) {
          alert(`Error: ${e.message}`);
        }
      }

      function showAddPropertyAccessModal(employeeId) {
        const employee = allEmployees.find(e => e.id === employeeId);
        if (!employee) return;

        let html = `
          <div style="background: var(--bg-gradient-start); border: 1px solid var(--card-border); border-radius: 8px; padding: 1.5rem; margin: 1rem 0;">
            <h4 style="margin: 0 0 1rem 0;">Grant Property Access to ${employee.name}</h4>
            <div style="display: grid; gap: 1rem;">
              <div>
                <label>Select Property</label>
                <select id="newAccessPropertyId" class="form-input">
                  <option value="">Choose a property...</option>
                  ${properties.map(p => `<option value="${p.id}">${p.name}${p.address ? ' - ' + p.address : ''}</option>`).join('')}
                </select>
              </div>
              <div>
                <strong>Permissions:</strong>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;">
                  <input type="checkbox" id="newAccessCanView" checked> Can View
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;">
                  <input type="checkbox" id="newAccessCanEdit"> Can Edit
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;">
                  <input type="checkbox" id="newAccessCanDelete"> Can Delete
                </label>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn-primary" onclick="grantPropertyAccess(${employeeId})" style="flex: 1;">
                  Grant Access
                </button>
                <button class="btn-secondary" onclick="this.closest('[style*=background]').remove(); openEmployeeModal(${employeeId})" style="flex: 1;">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        `;

        // Replace the modal content
        document.querySelector('[style*="position: fixed"] .card').insertAdjacentHTML('beforeend', html);
      }

      async function grantPropertyAccess(employeeId) {
        const propertyId = document.getElementById('newAccessPropertyId').value;
        const canView = document.getElementById('newAccessCanView').checked;
        const canEdit = document.getElementById('newAccessCanEdit').checked;
        const canDelete = document.getElementById('newAccessCanDelete').checked;

        if (!propertyId) {
          alert('Please select a property');
          return;
        }

        try {
          const fd = new FormData();
          fd.append('can_view', canView);
          fd.append('can_edit', canEdit);
          fd.append('can_delete', canDelete);

          const res = await fetch(`/api/users/${employeeId}/properties/${propertyId}/grant`, {
            method: 'POST',
            headers: authHeaders(),
            body: fd
          });

          if (res.ok) {
            alert('Property access granted successfully!');
            await loadEmployees();
            document.querySelector('[style*="position: fixed"]').remove();
          } else {
            const data = await res.json();
            alert(`Failed to grant access: ${data.detail || 'Unknown error'}`);
          }
        } catch (e) {
          alert(`Error: ${e.message}`);
        }
      }

      async function deleteEmployee(employeeId, employeeName) {
        if (!await confirm(`‚ö†Ô∏è WARNING ‚ö†Ô∏è\n\nThis will permanently delete ${employeeName} and remove their login access.\n\nAre you sure you want to continue?`)) {
          return;
        }

        // Double confirmation
        if (!await confirm(`This action cannot be undone. Delete ${employeeName}?`)) {
          return;
        }

        try {
          const res = await fetch(`/api/users/${employeeId}`, {
            method: 'DELETE',
            headers: authHeaders()
          });

          if (res.ok) {
            alert(`${employeeName} has been deleted successfully.`);
            await loadEmployees();
            document.querySelector('[style*="position: fixed"]').remove();
          } else {
            const data = await res.json();
            alert(`Failed to delete employee: ${data.detail || 'Unknown error'}`);
          }
        } catch (e) {
          alert(`Error: ${e.message}`);
        }
      }

      // Legacy function for backward compatibility
      async function loadUserManagement() {
        await loadEmployees();
      }

      async function editUserRole(userId, userName, currentRole) {
        const newRole = await prompt(`Change role for ${userName}\n\nCurrent role: ${currentRole}\n\nEnter new role (admin, manager, maintenance, leasing):`, currentRole);

        if (!newRole || newRole === currentRole) return;

        const validRoles = ['admin', 'manager', 'maintenance', 'leasing'];
        if (!validRoles.includes(newRole.toLowerCase())) {
          alert('Invalid role! Must be one of: admin, manager, maintenance, leasing');
          return;
        }

        try {
          const fd = new FormData();
          fd.append('role', newRole.toLowerCase());

          const res = await fetch(`/api/users/${userId}/role`, {
            method: 'POST',
            headers: authHeaders(),
            body: fd
          });

          if (res.ok) {
            alert(`Role updated successfully for ${userName}`);
            await loadUserManagement();
          } else {
            const data = await res.json();
            alert(`Failed to update role: ${data.detail || 'Unknown error'}`);
          }
        } catch (e) {
          alert(`Error: ${e.message}`);
        }
      }

      async function revokePropertyAccess(userId, propertyId, userName, propertyName) {
        if (!await confirm(`Remove ${userName}'s access to ${propertyName}?`)) return;

        try {
          const res = await fetch(`/api/users/${userId}/properties/${propertyId}/revoke`, {
            method: 'POST',
            headers: authHeaders()
          });

          if (res.ok) {
            alert('Access revoked successfully');
            await loadUserManagement();
          } else {
            const data = await res.json();
            alert(`Failed to revoke access: ${data.detail || 'Unknown error'}`);
          }
        } catch (e) {
          alert(`Error: ${e.message}`);
        }
      }

      function showGrantAccessModal(userId, userName) {
        let html = '<div style="margin-bottom: 1rem;">';
        html += `<p><strong>Grant property access to: ${userName}</strong></p>`;
        html += '<label style="display: block; margin: 0.5rem 0;">Property:</label>';
        html += '<select id="grantPropertyId" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--card-border); background: var(--card-bg); color: var(--text-primary);">';
        html += '<option value="">Select a property...</option>';

        properties.forEach(prop => {
          html += `<option value="${prop.id}">${prop.name}${prop.address ? ' - ' + prop.address : ''}</option>`;
        });

        html += '</select>';
        html += '<div style="margin-top: 1rem;">';
        html += '<label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;"><input type="checkbox" id="grantCanView" checked> Can View</label>';
        html += '<label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;"><input type="checkbox" id="grantCanEdit"> Can Edit</label>';
        html += '<label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0;"><input type="checkbox" id="grantCanDelete"> Can Delete</label>';
        html += '</div>';
        html += `<button class="btn-primary" onclick="executeGrantAccess(${userId})" style="width: 100%; margin-top: 1rem;">Grant Access</button>`;
        html += `<button class="btn-secondary" onclick="loadUserManagement()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>`;
        html += '</div>';

        document.getElementById('usersList').innerHTML = html;
      }

      async function executeGrantAccess(userId) {
        const propertyId = document.getElementById('grantPropertyId').value;
        const canView = document.getElementById('grantCanView').checked;
        const canEdit = document.getElementById('grantCanEdit').checked;
        const canDelete = document.getElementById('grantCanDelete').checked;

        if (!propertyId) {
          alert('Please select a property');
          return;
        }

        try {
          const fd = new FormData();
          fd.append('can_view', canView);
          fd.append('can_edit', canEdit);
          fd.append('can_delete', canDelete);

          const res = await fetch(`/api/users/${userId}/properties/${propertyId}/grant`, {
            method: 'POST',
            headers: authHeaders(),
            body: fd
          });

          if (res.ok) {
            alert('Property access granted successfully');
            await loadUserManagement();
          } else {
            const data = await res.json();
            alert(`Failed to grant access: ${data.detail || 'Unknown error'}`);
          }
        } catch (e) {
          alert(`Error: ${e.message}`);
        }
      }

      // ===== QUOTES MANAGEMENT =====

      function showVendorCredentials() {
        document.getElementById('vendorCredentialsSection').style.display = 'block';
        document.getElementById('newQuoteRequestSection').style.display = 'none';
        loadVendorCredentials();
        populateVendorPropertyDropdown();
      }

      function hideVendorCredentials() {
        document.getElementById('vendorCredentialsSection').style.display = 'none';
        document.getElementById('addVendorForm').reset();
      }

      function showNewQuoteRequest() {
        document.getElementById('newQuoteRequestSection').style.display = 'block';
        document.getElementById('vendorCredentialsSection').style.display = 'none';
        populateQuotePropertyDropdown();
      }

      function hideNewQuoteRequest() {
        document.getElementById('newQuoteRequestSection').style.display = 'none';
        document.getElementById('newQuoteForm').reset();
      }

      function populateVendorPropertyDropdown() {
        const select = document.getElementById('newVendorProperty');
        select.innerHTML = '<option value="">All Properties</option>';
        properties.forEach(prop => {
          select.innerHTML += `<option value="${prop.id}">${prop.name}</option>`;
        });
      }

      function populateQuotePropertyDropdown() {
        const select = document.getElementById('quoteProperty');
        select.innerHTML = '<option value="">Select property...</option>';
        properties.forEach(prop => {
          select.innerHTML += `<option value="${prop.id}">${prop.name}</option>`;
        });
      }

      async function loadVendorCredentials() {
        try {
          const res = await fetch('/api/vendors/credentials', {
            headers: authHeaders()
          });

          if (res.ok) {
            const credentials = await res.json();
            displayVendorCredentials(credentials);
          } else {
            document.getElementById('vendorCredentialsList').innerHTML =
              '<p style="color: var(--danger);">Failed to load vendor credentials</p>';
          }
        } catch (e) {
          console.error('Error loading credentials:', e);
          document.getElementById('vendorCredentialsList').innerHTML =
            '<p style="color: var(--danger);">Error loading credentials</p>';
        }
      }

      function displayVendorCredentials(credentials) {
        const container = document.getElementById('vendorCredentialsList');

        if (credentials.length === 0) {
          container.innerHTML = '<p style="color: var(--text-muted);">No vendor credentials saved yet. Add your first vendor below!</p>';
          return;
        }

        let html = '<div style="display: grid; gap: 1rem;">';

        credentials.forEach(cred => {
          const propertyName = cred.property_id ?
            (properties.find(p => p.id === cred.property_id)?.name || 'Unknown Property') :
            'All Properties';

          html += `
            <div class="card" style="background: var(--primary-light); padding: 1rem;">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0;">${cred.vendor_name}</h4>
                  <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0.25rem 0;">
                    <strong>Username:</strong> ${cred.username}
                  </p>
                  <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0.25rem 0;">
                    <strong>Property:</strong> ${propertyName}
                  </p>
                  <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0.25rem 0;">
                    <strong>Status:</strong> <span class="badge ${cred.is_active ? 'success' : 'danger'}">
                      ${cred.is_active ? 'Active' : 'Inactive'}
                    </span>
                  </p>
                </div>
                <button class="btn-danger" onclick="deleteVendorCredential(${cred.id})"
                        style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                  Delete
                </button>
              </div>
            </div>
          `;
        });

        html += '</div>';
        container.innerHTML = html;
      }

      async function addVendorCredential(event) {
        event.preventDefault();

        const formData = new FormData();
        formData.append('vendor_name', document.getElementById('newVendorName').value);
        formData.append('vendor_url', document.getElementById('newVendorUrl').value);
        formData.append('username', document.getElementById('newVendorUsername').value);
        formData.append('password', document.getElementById('newVendorPassword').value);

        const propertyId = document.getElementById('newVendorProperty').value;
        if (propertyId) {
          formData.append('property_id', propertyId);
        }

        try {
          const res = await fetch('/api/vendors/credentials', {
            method: 'POST',
            headers: authHeaders(),
            body: formData
          });

          if (res.ok) {
            alert('Vendor credentials saved successfully!');
            document.getElementById('addVendorForm').reset();
            await loadVendorCredentials();
          } else {
            const data = await res.json();
            alert(`Failed to save credentials: ${data.detail || 'Unknown error'}`);
          }
        } catch (e) {
          alert(`Error: ${e.message}`);
        }
      }

      async function deleteVendorCredential(credentialId) {
        if (!await confirm('Are you sure you want to delete this vendor credential?')) {
          return;
        }

        try {
          const res = await fetch(`/api/vendors/credentials/${credentialId}`, {
            method: 'DELETE',
            headers: authHeaders()
          });

          if (res.ok) {
            alert('Vendor credential deleted successfully');
            await loadVendorCredentials();
          } else {
            const data = await res.json();
            alert(`Failed to delete credential: ${data.detail || 'Unknown error'}`);
          }
        } catch (e) {
          alert(`Error: ${e.message}`);
        }
      }

      async function createQuoteRequest(event) {
        event.preventDefault();

        const formData = new FormData();
        formData.append('item_description', document.getElementById('quoteItemDescription').value);
        formData.append('quantity', document.getElementById('quoteQuantity').value);
        formData.append('auto_fetch', 'true');  // Enable automatic quote fetching

        const propertyId = document.getElementById('quoteProperty').value;
        if (propertyId) {
          formData.append('property_id', propertyId);
        }

        const notes = document.getElementById('quoteNotes').value;
        if (notes) {
          formData.append('notes', notes);
        }

        try {
          const res = await fetch('/api/quotes/request', {
            method: 'POST',
            headers: authHeaders(),
            body: formData
          });

          if (res.ok) {
            const data = await res.json();
            const quoteCount = data.quote_request.quote_count || 0;

            if (quoteCount > 0) {
              alert(`‚úì Quote request created! Automatically fetched ${quoteCount} quotes from vendors.`);
            } else {
              alert('‚úì Quote request created! Quotes are being fetched in the background...');
            }

            document.getElementById('newQuoteForm').reset();
            hideNewQuoteRequest();
            await loadQuoteRequests();
          } else {
            const errorText = await res.text();
            console.error('Failed to create quote request:', res.status, errorText);
            let errorDetail = 'Unknown error';
            try {
              const errorData = JSON.parse(errorText);
              errorDetail = errorData.detail || errorText;
            } catch {
              errorDetail = errorText;
            }
            alert(`Failed to create quote request (${res.status}): ${errorDetail}`);
          }
        } catch (e) {
          console.error('Error creating quote request:', e);
          alert(`Error: ${e.message}`);
        }
      }

      async function fetchQuotesForRequest(requestId) {
        try {
          const res = await fetch(`/api/quotes/request/${requestId}/fetch`, {
            method: 'POST',
            headers: authHeaders()
          });

          if (res.ok) {
            const data = await res.json();
            alert(`Successfully fetched ${data.quote_count} quotes!`);
            await loadQuoteRequests();
          } else {
            const data = await res.json();
            alert(`Failed to fetch quotes: ${data.detail || 'Unknown error'}`);
          }
        } catch (e) {
          alert(`Error fetching quotes: ${e.message}`);
        }
      }

      async function loadQuoteRequests() {
        const container = document.getElementById('quoteRequestsContent');
        if (!container) {
          console.error('quoteRequestsContent element not found');
          return;
        }

        try {
          const res = await fetch('/api/quotes/requests', {
            headers: authHeaders()
          });

          if (res.ok) {
            const requests = await res.json();
            displayQuoteRequests(requests);
          } else {
            const errorText = await res.text();
            console.error('Failed to load quote requests:', res.status, errorText);
            container.innerHTML =
              `<p style="color: var(--danger);">Failed to load quote requests (${res.status})</p>`;
          }
        } catch (e) {
          console.error('Error loading quote requests:', e);
          container.innerHTML =
            `<p style="color: var(--danger);">Error loading quote requests: ${e.message}</p>`;
        }
      }

      function displayQuoteRequests(requests) {
        const container = document.getElementById('quoteRequestsContent');

        if (!container) {
          console.error('quoteRequestsContent element not found');
          return;
        }

        if (!requests || requests.length === 0) {
          container.innerHTML = '<p style="color: var(--text-muted);">No quote requests yet. Create your first request above!</p>';
          return;
        }

        let html = '<div style="display: grid; gap: 1rem;">';

        // Sort by most recent first
        requests.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        requests.forEach(req => {
          const statusClass = req.status === 'completed' ? 'success' :
                             req.status === 'failed' ? 'danger' :
                             req.status === 'fetching' ? 'warning' : '';

          html += `
            <div class="card" style="padding: 1.5rem; cursor: pointer;"
                 onclick="viewQuoteDetails(${req.id})">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div>
                  <h4 style="margin: 0 0 0.5rem 0;">${req.item_description || 'N/A'}</h4>
                  <p style="font-size: 0.875rem; color: var(--text-secondary); margin: 0;">
                    Quantity: ${req.quantity || 1} | Requested: ${new Date(req.created_at).toLocaleDateString()}
                  </p>
                </div>
                <span class="badge ${statusClass}">${(req.status || 'pending').toUpperCase()}</span>
              </div>
              <div style="display: flex; gap: 1rem; align-items: center;">
                <span class="badge">${req.quote_count || 0} quotes</span>
                ${req.quote_count > 0 ? '<button class="btn-secondary" onclick="event.stopPropagation(); generateQuoteEmail(' + req.id + ')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">üìß Generate Email</button>' : ''}
              </div>
            </div>
          `;
        });

        html += '</div>';
        container.innerHTML = html;
      }

      async function viewQuoteDetails(requestId) {
        try {
          const res = await fetch(`/api/quotes/request/${requestId}`, {
            headers: authHeaders()
          });

          if (res.ok) {
            const data = await res.json();
            showQuoteDetailsModal(data);
          } else if (res.status === 404) {
            alert('Quote request not found. It may have been deleted. Refreshing list...');
            await loadQuoteRequests();
          } else {
            alert(`Failed to load quote details (${res.status})`);
          }
        } catch (e) {
          alert(`Error: ${e.message}`);
        }
      }

      function showQuoteDetailsModal(quoteRequest) {
        const quotes = quoteRequest.quotes || [];

        // Sort by price
        quotes.sort((a, b) => a.total_price - b.total_price);

        let html = `
          <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
                      display: flex; align-items: center; justify-content: center; z-index: 20000;"
               onclick="this.remove()">
            <div class="card" style="max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 2rem;"
                 onclick="event.stopPropagation();">
              <h3 style="margin-top: 0;">Quote Comparison: ${quoteRequest.item_description}</h3>
              <p style="color: var(--text-secondary);">
                Quantity: ${quoteRequest.quantity} | Property: ${quoteRequest.property_name || 'N/A'}
              </p>
        `;

        if (quotes.length === 0) {
          html += '<p style="color: var(--text-muted); margin: 2rem 0;">No quotes available yet.</p>';
        } else {
          html += '<div style="display: grid; gap: 1rem; margin-top: 1.5rem;">';

          quotes.forEach((quote, index) => {
            const bestPrice = index === 0 ? 'background: var(--success-light); border: 2px solid var(--success);' : '';

            html += `
              <div class="card" style="padding: 1.5rem; ${bestPrice}" id="quote-${quote.id}">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div style="flex: 1;">
                    <h4 style="margin: 0 0 0.5rem 0;">${quote.vendor_name} ${index === 0 ? '‚≠ê BEST PRICE' : ''}</h4>
                    <p style="margin: 0.25rem 0; font-size: 0.875rem;"><strong>Product:</strong> ${quote.item_name}</p>
                    ${quote.vendor_item_number ? `<p style="margin: 0.25rem 0; font-size: 0.875rem;"><strong>Item #:</strong> ${quote.vendor_item_number}</p>` : ''}
                    ${quote.availability ? `<p style="margin: 0.25rem 0; font-size: 0.875rem;"><strong>Availability:</strong> ${quote.availability}</p>` : ''}
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                      ${quote.vendor_url ? `<a href="${quote.vendor_url}" target="_blank" class="btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">View on Website</a>` : ''}
                      <button class="btn-danger" onclick="deleteQuote(${quote.id}, ${quoteRequest.id})"
                              style="padding: 0.5rem 1rem; font-size: 0.875rem; background: var(--error); color: white; border: none; border-radius: 6px; cursor: pointer;">
                        üóëÔ∏è Delete
                      </button>
                    </div>
                  </div>
                  <div style="text-align: right; margin-left: 1rem;">
                    <p style="font-size: 2rem; font-weight: bold; color: var(--success); margin: 0;">
                      $${quote.total_price.toFixed(2)}
                    </p>
                    <p style="font-size: 0.875rem; color: var(--text-muted); margin: 0;">
                      $${quote.unit_price.toFixed(2)} each
                    </p>
                  </div>
                </div>
              </div>
            `;
          });

          html += '</div>';

          // Add savings calculation
          if (quotes.length > 1) {
            const bestPrice = quotes[0].total_price;
            const worstPrice = quotes[quotes.length - 1].total_price;
            const savings = worstPrice - bestPrice;
            const savingsPct = (savings / worstPrice * 100).toFixed(1);

            html += `
              <div style="margin-top: 1.5rem; padding: 1rem; background: var(--info-light); border-radius: 8px;">
                <p style="margin: 0; font-weight: 600;">
                  üí∞ Potential Savings: $${savings.toFixed(2)} (${savingsPct}%) by choosing the best price
                </p>
              </div>
            `;
          }
        }

        html += `
              <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: space-between;">
                <div style="display: flex; gap: 1rem;">
                  <button class="btn-primary" onclick="generateQuoteEmail(${quoteRequest.id})">üìß Generate Email</button>
                  <button class="btn-secondary" onclick="this.closest('[onclick*=remove]').remove()">Close</button>
                </div>
                <button class="btn-danger" onclick="deleteQuoteRequest(${quoteRequest.id})"
                        style="background: var(--error); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600;">
                  üóëÔ∏è Delete Request
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', html);
      }

      async function deleteQuoteRequest(requestId) {
        if (!await confirm('Are you sure you want to delete this entire quote request? This will delete all associated quotes and cannot be undone.')) {
          return;
        }

        try {
          const res = await fetch(`/api/quotes/request/${requestId}`, {
            method: 'DELETE',
            headers: authHeaders()
          });

          if (res.ok) {
            const data = await res.json();
            alert(data.message);

            // Close the modal
            const modal = document.querySelector('[onclick*="remove"]');
            if (modal) {
              modal.remove();
            }

            // Refresh the quote requests list
            if (typeof loadQuoteRequests === 'function') {
              await loadQuoteRequests();
            }
          } else {
            const error = await res.json();
            alert(`Failed to delete quote request: ${error.detail || 'Unknown error'}`);
          }
        } catch (e) {
          alert(`Error: ${e.message}`);
        }
      }

      async function deleteQuote(quoteId, requestId) {
        if (!await confirm('Are you sure you want to delete this quote? This cannot be undone.')) {
          return;
        }

        try {
          const res = await fetch(`/api/quotes/${quoteId}`, {
            method: 'DELETE',
            headers: authHeaders()
          });

          if (res.ok) {
            const data = await res.json();
            alert(data.message);

            // Remove the quote element from the DOM
            const quoteElement = document.getElementById(`quote-${quoteId}`);
            if (quoteElement) {
              quoteElement.remove();
            }

            // Refresh the quote details to update count and best price
            await viewQuoteDetails(requestId);

            // Also refresh the quote requests list
            if (typeof loadQuoteRequests === 'function') {
              await loadQuoteRequests();
            }
          } else {
            const error = await res.json();
            alert(`Failed to delete quote: ${error.detail || 'Unknown error'}`);
          }
        } catch (e) {
          alert(`Error: ${e.message}`);
        }
      }

      async function generateQuoteEmail(requestId) {
        try {
          const res = await fetch(`/api/quotes/request/${requestId}/email`, {
            headers: authHeaders()
          });

          if (res.ok) {
            const data = await res.json();
            showEmailPreview(data.html);
          } else {
            alert('Failed to generate email');
          }
        } catch (e) {
          alert(`Error: ${e.message}`);
        }
      }

      function showEmailPreview(html) {
        const modal = `
          <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
                      display: flex; align-items: center; justify-content: center; z-index: 30000;"
               onclick="this.remove()">
            <div class="card" style="max-width: 900px; width: 95%; max-height: 95vh; overflow-y: auto; padding: 2rem;"
                 onclick="event.stopPropagation();">
              <h3 style="margin-top: 0;">Email Preview</h3>
              <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Copy the HTML below and paste into your email client, or use the preview below.
              </p>

              <div style="margin-bottom: 1.5rem;">
                <button class="btn-primary" onclick="copyEmailHTML()">üìã Copy HTML to Clipboard</button>
                <button class="btn-secondary" onclick="this.closest('[onclick*=remove]').remove()">Close</button>
              </div>

              <div style="border: 1px solid var(--card-border); border-radius: 8px; padding: 1rem; background: white; margin-bottom: 1rem;">
                <h4 style="margin-top: 0; color: var(--text-primary);">Email Preview:</h4>
                <div style="border: 1px solid #e2e8f0; border-radius: 4px; overflow: auto;">
                  ${html}
                </div>
              </div>

              <div>
                <h4 style="margin-top: 1.5rem; color: var(--text-primary);">HTML Code:</h4>
                <textarea id="emailHTMLCode" readonly style="width: 100%; height: 200px; font-family: monospace; font-size: 0.875rem; padding: 1rem; border: 1px solid var(--card-border); border-radius: 8px; background: var(--bg-gradient-start);">${html.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
              </div>
            </div>
          </div>
        `;

        // Store HTML for copying
        window.currentEmailHTML = html;

        document.body.insertAdjacentHTML('beforeend', modal);
      }

      function copyEmailHTML() {
        if (window.currentEmailHTML) {
          navigator.clipboard.writeText(window.currentEmailHTML).then(() => {
            alert('Email HTML copied to clipboard! You can now paste it into your email client.');
          }).catch(err => {
            alert('Failed to copy to clipboard. Please manually select and copy the HTML code.');
          });
        }
      }

      // Initialize
      window.addEventListener('DOMContentLoaded', () => {
        initDarkMode();

        const token = localStorage.getItem('bb_token');
        if (token) {
          showMainApp();
          // Start inactivity timer for logged-in users
          resetInactivityTimer();
        } else {
          document.getElementById('loginScreen').classList.add('active');
        }

        // Track user activity to reset inactivity timer
        const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
        activityEvents.forEach(event => {
          document.addEventListener(event, () => {
            const token = localStorage.getItem('bb_token');
            if (token) {
              resetInactivityTimer();
            }
          }, true);
        });
      });

      // AI Chat Widget Functions
      let chatMessages = [];
      let isChatMinimized = false;

      function toggleChatWidget() {
        const widget = document.getElementById('aiChatWidget');
        isChatMinimized = !isChatMinimized;

        if (isChatMinimized) {
          widget.classList.add('minimized');
        } else {
          widget.classList.remove('minimized');
          scrollChatToBottom();
        }
      }

      function addChatMessage(role, content) {
        chatMessages.push({ role, content });
        renderChatMessages();
        scrollChatToBottom();
      }

      function renderChatMessages() {
        const messagesContainer = document.getElementById('chatMessages');

        if (chatMessages.length === 0) {
          messagesContainer.innerHTML = `
            <div class="chat-welcome">
              <h3>Welcome to AI Assistant!</h3>
              <p>Ask me anything about your inventory, properties, invoices, or reports. I'm here to help!</p>
            </div>
          `;
          return;
        }

        let html = '';
        chatMessages.forEach(msg => {
          const avatar = msg.role === 'user' ? 'üë§' : 'ü§ñ';
          html += `
            <div class="chat-message ${msg.role}">
              <div class="chat-avatar">${avatar}</div>
              <div class="chat-bubble">${escapeHtml(msg.content)}</div>
            </div>
          `;
        });

        messagesContainer.innerHTML = html;
      }

      function showTypingIndicator() {
        const messagesContainer = document.getElementById('chatMessages');
        const typingHtml = `
          <div class="chat-typing" id="typingIndicator">
            <div class="chat-avatar">ü§ñ</div>
            <div class="chat-bubble">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        `;
        messagesContainer.innerHTML += typingHtml;
        scrollChatToBottom();
      }

      function hideTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
          indicator.remove();
        }
      }

      function scrollChatToBottom() {
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      async function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const sendBtn = document.getElementById('chatSendBtn');
        const message = input.value.trim();

        if (!message) return;

        // Add user message
        addChatMessage('user', message);
        input.value = '';
        input.style.height = 'auto';

        // Disable input while processing
        sendBtn.disabled = true;
        input.disabled = true;

        // Show typing indicator
        showTypingIndicator();

        try {
          const response = await fetch('/api/ai/query', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...authHeaders()
            },
            body: JSON.stringify({ query: message })
          });

          hideTypingIndicator();

          if (response.ok) {
            const data = await response.json();
            addChatMessage('assistant', data.answer || 'I apologize, but I could not generate a response.');
          } else {
            const errorData = await response.json().catch(() => ({}));
            addChatMessage('assistant', `Error: ${errorData.detail || 'Failed to get response. Please try again.'}`);
          }
        } catch (error) {
          hideTypingIndicator();
          addChatMessage('assistant', 'Sorry, I encountered an error while processing your request. Please try again.');
          console.error('Chat error:', error);
        } finally {
          // Re-enable input
          sendBtn.disabled = false;
          input.disabled = false;
          input.focus();
        }
      }

      function handleChatKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          sendChatMessage();
        }
      }

      function autoResizeChatInput() {
        const input = document.getElementById('chatInput');
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 100) + 'px';
      }

      // Initialize chat widget when page loads
      window.addEventListener('DOMContentLoaded', () => {
        renderChatMessages();
      });
    </script>

    <!-- AI Chat Widget -->
    <div id="aiChatWidget">
      <div class="chat-header" onclick="toggleChatWidget()">
        <div class="chat-header-title">
          <span>ü§ñ</span>
          <span>AI Assistant</span>
        </div>
        <div class="chat-header-controls">
          <button class="chat-control-btn" onclick="event.stopPropagation(); toggleChatWidget()">
            <span id="chatToggleIcon">‚àí</span>
          </button>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-container">
        <textarea
          id="chatInput"
          class="chat-input"
          placeholder="Ask me anything..."
          rows="1"
          onkeypress="handleChatKeyPress(event)"
          oninput="autoResizeChatInput()"
        ></textarea>
        <button id="chatSendBtn" class="chat-send-btn" onclick="sendChatMessage()">
          <span>‚û§</span>
        </button>
      </div>
    </div>
  </body>
</html>
